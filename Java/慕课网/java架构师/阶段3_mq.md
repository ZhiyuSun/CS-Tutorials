## 阶段3_分布式消息队列设计与落地

### 业界主流的分布式消息队列选型

#### 应用场景

服务解耦，削峰填谷，异步化缓冲

#### 应用思考点

生产端可靠性投递

消费端幂等

高可用、低延迟、可靠性、堆积能力、扩展性等

#### 主流消息队列

ActiveMQ

RabbitMQ

RocketMQ

Kafka

#### 如何技术选型

- 各个MQ的性能、优缺点、相应的业务场景
  - ActiveMQ，适用于中小型公司，高并发大流量不太合适
  - RabbitMQ，横向扩展能力不是特别好
- 集群架构模式，分布式、可扩展、高可用、可维护性
  - rabbitMQ，扩展性不好，可用性可维护性好
  - Kafka，可用性一点麻烦
- 综合成本问题，集群规模，人员成本
- 未来的方向、规划、思考

### Rabbitmq原理和集群架构

#### 集群架构

主备模式

远程模式

镜像模式（业界使用广泛）

多活模式

### Kafka

#### 介绍

基于pull，用于日志收集和传输

#### 特点

- 分布式
- 跨平台
- 实时性
- 伸缩性

#### kafka高性能的原因是什么

顺序写，Page Cache空中接力，高效读写

高性能，高吞吐

后台异步，主动Flush

预读策略，io调度

#### 集群模式

### Rabbitmq实战

erlang语言开发，基于AMQP协议

保证数据不丢失的前提做到高可靠性，可用性

#### 高性能的原因

- Erlang语言是的rabbitmq在broker之间进行数据交互的性能是非常优秀的
- Erlang的优点：有着和原生Socket一样的延迟

#### AMQP

- 高级消息队列协议，应用层协议的一个开放标准，为面向消息的中间件设计
- 图

#### AMQP核心概念

- Server：又称broker，接受客户端的连接，实现AMQP实体服务

- Connection: 连接，应用程序与Broker的网络连接

- Channel：网络信道，几乎所有的操作都在Channel中进行，Channel是进行消息读写的通道。客户端可建立多个Channel，每个Channel代表一个会话任务

- Message：消息，服务器和应用程序之间传送的数据，由Properties和Body组成。Properties可以对消息进行修饰，比如消息的优先级、延迟等高级特性；Body则就是消息体内容

- Virtual host：虚拟地址，用于进行逻辑隔离，最上层的消息路由。一个Virtual Host里面可以有若干个Exchange和Queue，同一个Virtual Host里面不能有相同名称的Exchange或Queue

- Exchange：交换机，接受消息，根据路由建转发消息到绑定的队列

- Binding：Exchange和Queue之间的虚拟连接，binding中可以包含routing key

- Routing key：一个路由规则，虚拟机可用它来确定如何路由一个特定消息

- Queue：也称Message Queue，消息队列，保存消息并将它们转发给消费者

#### 整体架构

图

#### 消息如何保障100%的投递成功

生产段的可靠性投递

- 保障消息的成功发出
- 保障MQ节点的成功接收
- 发送端收到MQ节点（Broker）确认应答
- 完善的消息进行补偿机制

解决方案：

- 消息落库，对消息状态进行打标（高并发场景下不合适）
- 消息的延迟投递，做二次确认，回调检查

大厂里没有做事务，完全是在做补偿

先持久化数据库，再去发消息

互联网大厂不加事务，会造成严重的性能瓶颈

先发消息，再去发延迟消息

目的：少做一次DB的存储

高并发，一定要保证性能

异步的去做补偿

callback 单独的服务

#### 幂等性

借鉴数据库乐观锁机制

update xxx set count=count-1, version-version+1 where version=1

消费端-幂等性保障

业界主流的幂等性操作：

- 唯一ID+指纹码机制，利用数据库主键去重（图）
- 利用redis的原子性去实现

利用redis原子性实现

- 使用redis进行幂等，需要考虑的问题
  - 是否要进行数据落库，如果落库的话，关键解决的问题是数据库和缓存如何做到原子性
  - 如果不进行落库，那么都存储到缓存中，如何设置定时同步的策略

### rabbitMq整合springBoot

### 主备模式

### Rabbitmq基础组件封装

迅速、延迟、可靠

消息异步化序列化

连接池化、高性能

完备的补偿机制

#### 基础api的封装

建造者模式

看到3-6，后面的有点难，一直到3-25都没有看

### Kafka

后面的都听不懂

